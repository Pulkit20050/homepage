import os
import base64
import time
from flask import Flask, request, jsonify
from flask_cors import CORS
from PIL import Image

# Import DeepFace and Pandas for the core logic
from deepface import DeepFace
import pandas as pd

# 1. Initialize the Flask App and CORS
# =======================================
app = Flask(__name__)
CORS(app)


# 2. Define and Create Necessary Directories
# ===========================================
# Get the directory where this script is located
BASE_DIR = os.path.dirname(__file__)

# Define paths for uploads, the face database, and reports
UPLOADS_DIR = os.path.join(BASE_DIR, 'uploads')
DATABASE_DIR = os.path.join(BASE_DIR, 'database')
REPORTS_DIR = os.path.join(BASE_DIR, 'reports')

# Create these directories if they don't already exist
os.makedirs(UPLOADS_DIR, exist_ok=True)
os.makedirs(DATABASE_DIR, exist_ok=True)
os.makedirs(REPORTS_DIR, exist_ok=True)


# 3. Create the API Endpoint for Uploading
# ==========================================
@app.route('/upload', methods=['POST'])
def upload_files():
    try:
        # Get the list of base64 image strings from the request
        data = request.get_json()
        images = data.get('images')

        if not images or not isinstance(images, list):
            return jsonify({'message': 'No images received.'}), 400

        # --- Save and Process Uploaded Images ---
        saved_files = []
        for index, base64_image in enumerate(images):
            try:
                # Decode the base64 string
                header, encoded_data = base64_image.split(',', 1)
                image_data = base64.b64decode(encoded_data)
                
                # Create a unique filename using a timestamp
                file_name = f'capture-{int(time.time())}-{index}.png'
                file_path = os.path.join(UPLOADS_DIR, file_name)

                # Save the decoded image to the 'uploads' directory
                with open(file_path, 'wb') as f:
                    f.write(image_data)
                
                saved_files.append(file_name)
            except (ValueError, TypeError) as e:
                print(f"Skipping malformed base64 string at index {index}: {e}")
                continue
        
        print(f"{len(saved_files)} images saved successfully.")

        # --- Perform Face Recognition on Saved Images ---
        recognition_results = []
        for file_name in saved_files:
            image_path = os.path.join(UPLOADS_DIR, file_name)
            
            # --- OPTIMIZATION: Resize the image before recognition ---
            try:
                img = Image.open(image_path)
                # Resize to a max width of 640px, maintaining aspect ratio
                if img.width > 640:
                    w_percent = (640 / float(img.width))
                    h_size = int((float(img.height) * float(w_percent)))
                    img = img.resize((640, h_size), Image.Resampling.LANCZOS)
                    img.save(image_path)
            except Exception as e:
                print(f"Could not resize image {file_name}: {e}")
                continue # Skip to the next file if resizing fails

            # --- Run Face Recognition ---
            try:
                # Use DeepFace.find with the fast 'yunet' detector
                dfs = DeepFace.find(
                    img_path=image_path,
                    db_path=DATABASE_DIR,
                    model_name='ArcFace',
                    enforce_detection=False,
                    detector_backend='yunet'
                )

                if dfs and not dfs[0].empty:
                    # Get the identity of the best match
                    identity_path = dfs[0].iloc[0]['identity']
                    person_name = os.path.basename(os.path.dirname(identity_path))
                    recognition_results.append({
                        'uploaded_file': file_name,
                        'identified_person': person_name.replace("_", " ").title()
                    })
                else:
                    recognition_results.append({
                        'uploaded_file': file_name,
                        'identified_person': 'Unknown'
                    })

            except Exception as e:
                print(f"Could not process {file_name} for recognition: {e}")
                recognition_results.append({
                    'uploaded_file': file_name,
                    'identified_person': f'Recognition Error'
                })

        # --- Create and Save the Excel Report ---
        if recognition_results:
            df = pd.DataFrame(recognition_results)
            report_filename = f'Recognition_Report_{int(time.time())}.xlsx'
            report_path = os.path.join(REPORTS_DIR, report_filename)
            
            df.to_excel(report_path, index=False)
            print(f"Excel report saved to {report_path}")
            
            return jsonify({
                'message': f'Upload and recognition complete! Report saved as {report_filename}',
                'files_saved': len(saved_files),
                'report_file': report_filename
            }), 200
        else:
            return jsonify({'message': 'Images uploaded but no recognition was performed.'}), 200

    except Exception as e:
        print(f"An unexpected server error occurred: {e}")
        return jsonify({'message': 'An unexpected server error occurred.'}), 500


# 4. Run the Flask App
# =======================
if __name__ == '__main__':
    # Run the app on all available network interfaces on port 3000
    app.run(host='0.0.0.0', port=5000, debug=True)
