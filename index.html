import os
import base64
import time
from datetime import datetime
from flask import Flask, request, jsonify
from flask_cors import CORS
from PIL import Image

# It's good practice to handle potential import errors
try:
    from deepface import DeepFace
    import pandas as pd
except ImportError:
    print("ERROR: One or more required Python packages are not installed.")
    print("Please run: pip install Flask Flask-CORS deepface pandas openpyxl Pillow tf-keras")
    exit()

# 1. Initialize the Flask App and CORS
app = Flask(__name__)
CORS(app)

# 2. Define and Create Necessary Directories
BASE_DIR = os.path.dirname(__file__)
UPLOADS_DIR = os.path.join(BASE_DIR, 'uploads')
DATABASE_DIR = os.path.join(BASE_DIR, 'database')
REPORTS_DIR = os.path.join(BASE_DIR, 'reports')

os.makedirs(UPLOADS_DIR, exist_ok=True)
os.makedirs(DATABASE_DIR, exist_ok=True)
os.makedirs(REPORTS_DIR, exist_ok=True)

# 3. Helper Functions
def get_known_students(db_path):
    """Gets a clean, sorted list of student names from the database subdirectories."""
    try:
        students = [d for d in os.listdir(db_path) if os.path.isdir(os.path.join(db_path, d))]
        return sorted([s.replace("_", " ").title() for s in students])
    except FileNotFoundError:
        return []

def get_latest_report_path():
    """Finds the most recently created attendance report file."""
    try:
        report_files = [os.path.join(REPORTS_DIR, f) for f in os.listdir(REPORTS_DIR) if f.startswith('Attendance_Report') and f.endswith('.xlsx')]
        if not report_files:
            return None
        return max(report_files, key=os.path.getctime)
    except FileNotFoundError:
        return None

# 4. API Endpoints
@app.route('/upload', methods=['POST'])
def upload_files():
    try:
        data = request.get_json()
        images = data.get('images')
        if not images: return jsonify({'message': 'No images received.'}), 400

        saved_files = []
        for index, base64_image in enumerate(images):
            try:
                header, encoded_data = base64_image.split(',', 1)
                image_data = base64.b64decode(encoded_data)
                file_name = f'capture-{int(time.time())}-{index}.png'
                file_path = os.path.join(UPLOADS_DIR, file_name)
                with open(file_path, 'wb') as f: f.write(image_data)
                saved_files.append(file_name)
            except Exception: continue

        all_known_students = get_known_students(DATABASE_DIR)
        attendance_status = {student: 'Absent' for student in all_known_students}

        for file_name in saved_files:
            image_path = os.path.join(UPLOADS_DIR, file_name)
            try:
                img = Image.open(image_path)
                if img.width > 640:
                    w_percent = (640 / float(img.width))
                    h_size = int((float(img.height) * float(w_percent)))
                    img = img.resize((640, h_size), Image.Resampling.LANCZOS)
                    img.save(image_path)
                
                dfs = DeepFace.find(img_path=image_path, db_path=DATABASE_DIR, model_name='ArcFace', enforce_detection=False, detector_backend='yunet')
                if dfs and not dfs[0].empty:
                    for _, row in dfs[0].iterrows():
                        identity_path = row['identity']
                        person_name = os.path.basename(os.path.dirname(identity_path)).replace("_", " ").title()
                        if person_name in attendance_status:
                            attendance_status[person_name] = 'Present'
            except Exception as e:
                print(f"Recognition error for {file_name}: {e}")

        current_timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        report_data = [{'Timestamp': current_timestamp, 'Name': name, 'Status': status} for name, status in attendance_status.items()]
        
        if not report_data: return jsonify({'message': 'No known students in the database to generate a report.'}), 400

        df = pd.DataFrame(report_data)
        report_filename = f'Attendance_Report_{datetime.now().strftime("%Y%m%d_%H%M%S")}.xlsx'
        report_path = os.path.join(REPORTS_DIR, report_filename)
        df.to_excel(report_path, index=False)
        
        return jsonify({'message': f'Report saved as {report_filename}'}), 200

    except Exception as e:
        print(f"ERROR in /upload: {e}")
        return jsonify({'message': f'An unexpected server error occurred: {e}'}), 500

@app.route('/mark-late', methods=['POST'])
def mark_late():
    try:
        data = request.get_json()
        late_students = data.get('late_students')
        if not late_students: return jsonify({'message': 'No late students received.'}), 400

        latest_report_path = get_latest_report_path()
        if not latest_report_path:
            return jsonify({'message': 'No attendance report found to update. Please run attendance first.'}), 404

        df = pd.read_excel(latest_report_path)
        for student_name in late_students:
            df.loc[df['Name'] == student_name, 'Status'] = 'Late Arrival'

        df.to_excel(latest_report_path, index=False)
        return jsonify({'message': 'Attendance report updated with late arrivals.'}), 200

    except Exception as e:
        print(f"ERROR in /mark-late: {e}")
        return jsonify({'message': f'Server error: {e}'}), 500

@app.route('/get-latest-report', methods=['GET'])
def get_latest_report():
    try:
        latest_report_path = get_latest_report_path()
        if not latest_report_path:
            return jsonify([]), 200

        df = pd.read_excel(latest_report_path)
        # Standardize column name just in case old reports exist
        if 'Status (Present/Absent)' in df.columns:
            df.rename(columns={'Status (Present/Absent)': 'Status'}, inplace=True)
        
        return jsonify(df.to_dict(orient='records')), 200

    except Exception as e:
        print(f"ERROR in /get-latest-report: {e}")
        return jsonify({'message': f'Error fetching report: {e}'}), 500

# 5. Run the Flask App
if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)
