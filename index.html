<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Veriface - Attendance Capture</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Mediapipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js" crossorigin="anonymous"></script>

  <style>
    :root {
      --primary-color: #4f46e5;
      --primary-hover: #4338ca;
      --secondary-color: #64748b;
      --secondary-hover: #475569;
      --bg-light: #f8fafc;
      --bg-white: #ffffff;
      --border-color: #e2e8f0;
      --text-dark: #1e293b;
      --text-light: #64748b;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background-color: var(--bg-light);
      color: var(--text-dark);
    }
    .header {
      background-color: var(--bg-white);
      padding: 1rem 2rem;
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid var(--border-color);
    }
    .brand { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); }
    .nav a {
      color: var(--text-light); text-decoration: none; padding: 0.5rem 1rem;
      margin-left: 0.5rem; border-radius: 6px; font-weight: 500;
      cursor: pointer; transition: all 0.2s;
    }
    .nav a.active { background-color: var(--primary-color); color: white; }
    .main-content {
      padding: 2rem; display: flex; flex-direction: column;
      align-items: center; gap: 2rem;
    }
    .capture-card {
      background-color: var(--bg-white);
      border-radius: 12px; box-shadow: var(--shadow);
      padding: 2.5rem; text-align: center;
      width: 100%; max-width: 700px;
    }
    .camera-icon-container { cursor: pointer; margin-bottom: 2rem; }
    .camera-icon { width: 72px; height: 72px; color: var(--primary-color); }
    .btn {
      display: inline-flex; align-items: center; gap: 0.5rem;
      padding: 0.75rem 1.5rem; border: none; border-radius: 8px;
      font-size: 1rem; font-weight: 500; cursor: pointer;
    }
    .btn-primary { background-color: var(--primary-color); color: white; }
    .btn-secondary { background-color: var(--secondary-color); color: white; }
    .btn:disabled { background: #d1d5db; cursor: not-allowed; }
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5); display: none;
      justify-content: center; align-items: center; z-index: 1000;
    }
    .modal-overlay.show { display: flex; }
    .modal-content {
      background: var(--bg-white); border-radius: 12px;
      padding: 1rem; width: 90%; max-width: 680px;
      position: relative;
    }
    .modal-video-container {
      position: relative; width: 100%; padding-top: 75%;
      background: #000; border-radius: 8px; overflow: hidden;
    }
    #webcam, #output_canvas {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
    }
    .modal-capture-btn {
      margin: 1rem auto; display: block;
      width: 64px; height: 64px; border-radius: 50%;
      border: 4px solid var(--primary-color); background: white;
      cursor: pointer;
    }
    .photo-gallery {
      display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center;
      width: 100%; max-width: 900px;
    }
    .photo-gallery div {
      display: flex; flex-direction: column; align-items: center;
    }
    .photo-gallery img {
      width: 160px; height: 120px; border: 2px solid var(--border-color);
      border-radius: 8px; object-fit: cover; box-shadow: var(--shadow);
    }
    .status { min-height: 24px; font-weight: 500; }
    .status.success { color: green; }
    .status.error { color: red; }
    .status.info { color: #075985; }
  </style>
</head>
<body>

<header class="header">
  <div class="brand">Veriface</div>
  <nav class="nav">
    <a id="captureNav" class="active">Capture</a>
    <a id="studentListNav">Student-List</a>
    <a id="insightsNav">Insights</a>
  </nav>
</header>

<main class="main-content">
  <div class="capture-card">
    <h2>Capture Attendance</h2>
    <p>Click the camera to start a session. You can capture multiple photos of the class.</p>
    <div id="openCameraModalBtn" class="camera-icon-container">
      <svg class="camera-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
              d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169"/>
      </svg>
    </div>
    <div class="action-buttons">
      <button id="uploadBtn" class="btn btn-primary" disabled>Upload Attendance</button>
    </div>
  </div>
  <p id="status" class="status"></p>
  <div id="photoGallery" class="photo-gallery"></div>
</main>

<!-- Camera Modal -->
<div id="cameraModal" class="modal-overlay">
  <div class="modal-content">
    <button id="closeCameraModalBtn">&times;</button>
    <div class="modal-video-container">
      <video id="webcam" autoplay playsinline></video>
      <canvas id="output_canvas" width="640" height="480"></canvas>
    </div>
    <button id="modalCaptureBtn" class="modal-capture-btn"></button>
  </div>
</div>

<script>
  const SERVER_URL = "http://localhost:5000";
  const openCameraModalBtn = document.getElementById('openCameraModalBtn');
  const closeCameraModalBtn = document.getElementById('closeCameraModalBtn');
  const cameraModal = document.getElementById('cameraModal');
  const modalCaptureBtn = document.getElementById('modalCaptureBtn');
  const uploadBtn = document.getElementById('uploadBtn');
  const photoGallery = document.getElementById('photoGallery');
  const statusEl = document.getElementById('status');
  const videoElement = document.getElementById('webcam');
  const canvasElement = document.getElementById('output_canvas');
  const canvasCtx = canvasElement.getContext('2d');
  let camera = null;

  // === Camera logic ===
  function startCamera() {
    navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" }, width: 640, height: 480 }
    }).then((stream) => {
      videoElement.srcObject = stream;
      videoElement.play();
      camera = new Camera(videoElement, {
        onFrame: async () => {
          await faceDetection.send({ image: videoElement });
        },
        width: 640,
        height: 480
      });
      camera.start();
    }).catch(err => {
      console.error("Camera error:", err);
      alert("Unable to access back camera.");
    });
  }
  function stopCamera() {
    if (camera) { camera.stop(); camera = null; }
    if (videoElement.srcObject) {
      videoElement.srcObject.getTracks().forEach(track => track.stop());
      videoElement.srcObject = null;
    }
  }

  // === Mediapipe Face Detection ===
  const faceDetection = new FaceDetection({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}`
  });
  faceDetection.setOptions({ model: 'short', minDetectionConfidence: 0.5 });
  faceDetection.onResults(onResults);

  function onResults(results) {
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
    if (results.detections) {
      for (const detection of results.detections) {
        const box = detection.boundingBox;
        canvasCtx.strokeStyle = "#4f46e5";
        canvasCtx.lineWidth = 4;
        canvasCtx.strokeRect(box.xCenter - box.width/2, box.yCenter - box.height/2, box.width, box.height);
      }
    }
  }

  // === Capture + Recognize ===
  function capturePhoto() {
    if (!camera) return;
    const imageDataUrl = canvasElement.toDataURL('image/jpeg', 0.7);

    const container = document.createElement('div');
    const img = document.createElement('img');
    img.src = imageDataUrl;
    container.appendChild(img);

    const details = document.createElement('p');
    details.textContent = "Processing...";
    container.appendChild(details);

    photoGallery.appendChild(container);
    uploadBtn.disabled = false;

    // Send to backend recognition
    fetch(`${SERVER_URL}/recognize`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ image: imageDataUrl })
    })
    .then(res => res.json())
    .then(data => {
      details.textContent = data.name ? `ðŸŽ“ ${data.name}` : "Unknown Student";
    })
    .catch(err => {
      console.error(err);
      details.textContent = "âŒ Recognition Failed";
    });
  }

  // === Upload all photos ===
  async function uploadPhotos() {
    const images = document.querySelectorAll('#photoGallery img');
    if (images.length === 0) {
      statusEl.textContent = "No photos to upload.";
      statusEl.className = "status info";
      return;
    }
    statusEl.textContent = "Uploading...";
    statusEl.className = "status info";

    const imageData = Array.from(images).map(img => img.src);
    try {
      const res = await fetch(`${SERVER_URL}/upload`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ images: imageData })
      });
      const result = await res.json();
      statusEl.textContent = `âœ… ${result.message}`;
      statusEl.className = "status success";
    } catch (err) {
      console.error(err);
      statusEl.textContent = "âŒ Upload failed.";
      statusEl.className = "status error";
    }
  }

  // === Event Listeners ===
  openCameraModalBtn.addEventListener('click', () => {
    cameraModal.classList.add('show');
    startCamera();
  });
  closeCameraModalBtn.addEventListener('click', () => {
    cameraModal.classList.remove('show');
    stopCamera();
  });
  modalCaptureBtn.addEventListener('click', capturePhoto);
  uploadBtn.addEventListener('click', uploadPhotos);
</script>
</body>
</html>
