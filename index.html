<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Veriface - Attendance Capture</title>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js" crossorigin="anonymous"></script>

  <style>
    :root {
      --primary-blue: #2c5282;
      --secondary-blue: #3a72b3;
      --light-gray: #f7fafc;
      --medium-gray: #e2e8f0;
      --dark-gray: #4a5568;
      --text-color: #2d3748;
    }
    body { font-family: system-ui, sans-serif; margin: 0; background-color: var(--light-gray); color: var(--text-color); }
    .header {
      background-color: var(--primary-blue); padding: 1rem 2rem;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .brand { font-size: 1.5rem; font-weight: bold; color: white; }
    .nav a {
      color: white; text-decoration: none; padding: 0.5rem 1rem;
      margin-left: 0.5rem; border-radius: 6px; font-weight: 500;
    }
    .nav a.active, .nav a:hover { background-color: var(--secondary-blue); }

    .main-content { padding: 2rem; display: flex; flex-direction: column; align-items: center; }
    .capture-card {
      background-color: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      padding: 2.5rem; text-align: center; width: 100%; max-width: 800px;
    }
    .capture-card h2 { margin-top: 0; font-size: 1.5rem; }
    .capture-card p { color: var(--dark-gray); margin-bottom: 2rem; }
    .camera-icon-container { cursor: pointer; margin-bottom: 2rem; }
    .camera-icon { width: 80px; height: 80px; color: var(--primary-blue); }
    .upload-btn {
      background-color: #d1d5db; color: #6b7280; padding: 0.75rem 2rem;
      border: none; border-radius: 6px; font-size: 1rem; font-weight: 500;
      cursor: not-allowed; transition: background-color 0.2s;
    }
    .upload-btn:not(:disabled) {
      background-color: var(--primary-blue); color: white; cursor: pointer;
    }
    .upload-btn:not(:disabled):hover { background-color: var(--secondary-blue); }

    /* Modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: none; justify-content: center; align-items: center;
      z-index: 1000;
    }
    .modal-content {
      position: relative; background-color: #2d3748; padding: 1rem;
      border-radius: 12px; width: 90%; max-width: 680px;
    }
    .modal-close-btn {
      position: absolute; top: -15px; right: -15px;
      background-color: white; color: var(--dark-gray);
      border: none; border-radius: 50%; width: 30px; height: 30px;
      font-size: 1.2rem; cursor: pointer; display: flex; justify-content: center; align-items: center;
    }
    .modal-video-container {
      position: relative; width: 100%; padding-top: 75%;
      background: #000; border-radius: 8px; overflow: hidden;
    }
    #webcam, #output_canvas {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    }
    #webcam { transform: scaleX(-1); }
    .modal-capture-btn {
      background-color: white; border: 4px solid var(--primary-blue);
      border-radius: 50%; width: 60px; height: 60px;
      cursor: pointer; display: block; margin: 1.5rem auto 0.5rem;
    }

    /* Gallery */
    .photo-gallery {
      display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;
      margin-top: 2rem; width: 100%; max-width: 900px;
    }
    .photo-gallery img {
      width: 160px; height: 120px; border: 3px solid var(--medium-gray);
      border-radius: 8px; object-fit: cover; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .status { margin-top: 1.5rem; font-size: 1rem; font-weight: bold; min-height: 24px; }
  </style>
</head>
<body>

  <header class="header">
    <div class="brand">Veriface</div>
    <nav class="nav">
      <a href="#" class="active">Capture</a>
      <a href="#">Student-List</a>
      <a href="#">Insights</a>
    </nav>
  </header>

  <main class="main-content">
    <div class="capture-card">
      <h2>Capture Attendance</h2>
      <p>Click the camera to take one or more photos of the class.</p>
      <div id="openModalBtn" class="camera-icon-container">
        <svg class="camera-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 10.5c-1.38 0-2.5 1.12-2.5 2.5s1.12 2.5 2.5 2.5 2.5-1.12 2.5-2.5-1.12-2.5-2.5-2.5zm7.5-6.5H16.5c-.41-1.16-1.52-2-2.83-2h-3.33c-1.31 0-2.42.84-2.83 2H4.5C3.12 4 2 5.12 2 6.5v11C2 18.88 3.12 20 4.5 20h15c1.38 0 2.5-1.12 2.5-2.5v-11C22 5.12 20.88 4 19.5 4zm-7.5 13c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
        </svg>
      </div>
      <button id="uploadBtn" class="upload-btn" disabled>Upload Attendance</button>
    </div>
    <p id="status" class="status"></p>
    <div id="photoGallery" class="photo-gallery"></div>
  </main>

  <div id="cameraModal" class="modal-overlay">
    <div class="modal-content">
      <button id="closeModalBtn" class="modal-close-btn">&times;</button>
      <div class="modal-video-container">
        <video id="webcam" autoplay playsinline></video>
        <canvas id="output_canvas" width="640" height="480"></canvas>
      </div>
      <button id="modalCaptureBtn" class="modal-capture-btn"></button>
    </div>
  </div>

  <script>
    const openModalBtn = document.getElementById('openModalBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const cameraModal = document.getElementById('cameraModal');
    const modalCaptureBtn = document.getElementById('modalCaptureBtn');
    const videoElement = document.getElementById('webcam');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const uploadBtn = document.getElementById('uploadBtn');
    const photoGallery = document.getElementById('photoGallery');
    const statusEl = document.getElementById('status');

    // ✅ Fixed backend URL
    // Change the port number from 3000 to 5000
    const SERVER_URL = 'https://your-ngrok-url.ngrok-free.app:5000/upload';

    let camera = null;

    // === Modal and Camera ===
    function openModal() {
      cameraModal.style.display = 'flex';
      startCamera();
    }
    function closeModal() {
      cameraModal.style.display = 'none';
      stopCamera();
    }
    function startCamera() {
      camera = new Camera(videoElement, {
        onFrame: async () => { await faceDetection.send({ image: videoElement }); },
        width: 640, height: 480
      });
      camera.start();
    }
    function stopCamera() {
      if (camera) {
        camera.stop();
        camera = null;
      }
    }

    // === Mediapipe Face Detection ===
    const faceDetection = new FaceDetection({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}` });
    faceDetection.setOptions({ model: 'short', minDetectionConfidence: 0.5 });
    function onResults(results) {
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
      if (results.detections) {
        for (const detection of results.detections) {
          drawRectangle(canvasCtx, detection.boundingBox, { color: 'red', lineWidth: 4, fillColor: '#00000000' });
        }
      }
    }
    faceDetection.onResults(onResults);

    // === Capture Photo ===
    function capturePhoto() {
      if (!camera) return;
      const imageDataUrl = canvasElement.toDataURL('image/png');
      const img = document.createElement('img');
      img.src = imageDataUrl;
      img.alt = "Captured Photo";
      photoGallery.appendChild(img);
      uploadBtn.disabled = false;
    }

    // === Upload Photos ===
    async function uploadPhotos() {
      const images = document.querySelectorAll('#photoGallery img');
      if (images.length === 0) {
        statusEl.textContent = 'No photos to upload.';
        return;
      }
      statusEl.textContent = 'Uploading...';
      uploadBtn.disabled = true;
      const imageData = Array.from(images).map(img => img.src);
      try {
        const response = await fetch(SERVER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ images: imageData })
        });
        if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
        const result = await response.json();
        statusEl.textContent = `✅ ${result.message}`;
      } catch (error) {
        console.error('Upload failed:', error);
        statusEl.textContent = `❌ Upload failed. See console for details.`;
      } finally {
        uploadBtn.disabled = false;
      }
    }

    // === Event Listeners ===
    openModalBtn.addEventListener('click', openModal);
    closeModalBtn.addEventListener('click', closeModal);
    modalCaptureBtn.addEventListener('click', capturePhoto);
    uploadBtn.addEventListener('click', uploadPhotos);
  </script>
</body>
</html>
